loki:
  commonConfig:
    replication_factor: 2  # Match your ingester replicas
  schemaConfig:
    configs:
    - from: "2024-01-01"  # Use a more recent date
      index:
        period: 24h
        prefix: index_
      object_store: filesystem
      schema: v13  # v12 is deprecated, use v13
      store: tsdb  # Use tsdb instead of boltdb-shipper
  storage:
    filesystem:
      chunks_directory: /var/loki/chunks 
      rules_directory: /var/loki/rules
    type: filesystem
  
  # Add retention configuration
  limits_config:
    retention_period: 720h  # 30 days, adjust as needed
  
  compactor:
    retention_enabled: true
    working_directory: /var/loki/compactor
    compaction_interval: 10m

# Persistence specifically for ingesters
ingester:
  replicas: 2
  maxUnavailable: 1
  persistence:
    enabled: true
    size: 20Gi
    storageClassName: gp2
  # Add resource limits to prevent OOM
  resources:
    limits:
      memory: 2Gi
    requests:
      memory: 1Gi

# Add persistence for other components
querier:
  replicas: 2
  maxUnavailable: 1
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: gp2

# Compactor needs persistence too
compactor:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: gp2

distributor:
  replicas: 2
  maxUnavailable: 1

query_frontend:
  replicas: 2
  maxUnavailable: 1

gateway:
  enabled: true